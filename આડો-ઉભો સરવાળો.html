<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ркЧркгрк┐ркд рк╕рк░рк╡рк╛рк│рлЛ ркХрлЛркпркбрлЛ</title>
    <!-- Tailwind CSS CDN ркорк╛ркЯрлЗ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter рклрлЛркирлНркЯ -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* рк╣рк│рк╡рлЛ ркЧрлНрк░рлЗ ркмрлЗркХркЧрлНрк░рк╛ркЙркирлНркб */
        }
        .grid-cell {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem; /* ркорлЛркЯрлЛ рклрлЛркирлНркЯ */
            font-weight: 700;
            border-radius: 0.5rem;
            transition: all 0.2s;
            aspect-ratio: 1 / 1; /* ркХрлЛрк╖рлЛркирлЗ ркЪрлЛрк░рк╕ рк░рк╛ркЦрлЛ */
        }
        .input-cell {
            text-align: center;
            background-color: #fff;
            border: 3px solid #3b82f6; /* рк╡рк╛ркжрк│рлА ркХрк┐ркирк╛рк░рлА */
            color: #1e40af;
            outline: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .input-cell:focus {
            border-color: #ef4444; /* рклрлЛркХрк╕ рккрк░ рк▓рк╛рк▓ */
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5);
        }
        .fixed-cell {
            background-color: #dbeafe; /* рк╣рк│рк╡рлЛ рк╡рк╛ркжрк│рлА ркмрлЗркХркЧрлНрк░рк╛ркЙркирлНркб */
            color: #1e40af;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.1);
        }
        /* рк╕рк░рк╡рк╛рк│рк╛ркирк╛ рккрлНрк░ркжрк░рлНрк╢рки ркорк╛ркЯрлЗ рк╕рлНркЯрк╛ркЗрк▓ */
        .sum-display {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* рккркВркХрлНркдрк┐ рк╕рк░рк╡рк╛рк│рк╛ ркЬркоркгрлА ркмрк╛ркЬрлБркП рк╢рк░рлВ ркерк╢рлЗ */
            padding-left: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: #4b5563; /* Default gray text */
            transition: color 0.3s;
        }
        .col-sum-display {
            justify-content: center; /* рк╕рлНркдркВркн рк╕рк░рк╡рк╛рк│рк╛ ркХрлЗркирлНркжрлНрк░ркорк╛ркВ */
            padding-left: 0;
            padding-top: 0.5rem;
            height: 100%;
        }
        /* ркЦрк╛рк▓рлА Firebase auth div ркорк╛ркЯрлЗ */
        #loading-auth {
            height: 0;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body class="p-4 flex items-start justify-center min-h-screen">

    <div id="app" class="w-full max-w-lg bg-white p-6 md:p-8 rounded-xl shadow-2xl space-y-6">
        <!-- рк╢рлАрк░рлНрк╖ркХ ркЕркирлЗ ркХрлНрк░рк┐ркПркЯрк░ркирлБркВ ркирк╛рко -->
        <h1 class="text-3xl md:text-4xl font-extrabold text-center text-gray-800 mb-0">ркЖркбрлЛ-ркЙркнрлЛ рк╕рк░рк╡рк╛рк│рлЛ ркХрк░рлЛ</h1>
        <p class="text-md font-medium text-center text-gray-500 mb-4 pt-1">Created by : Rajesh Barochia</p>
        
        <!-- рклрк╛ркпрк░ркмрлЗркЭ/ркУркерлЗркирлНркЯрк┐ркХрлЗрк╢рки рк▓рлЛркбрк┐ркВркЧ рк╕рлНркЯрлЗркЯ (рк╣рк╡рлЗ ркЫрлБрккрк╛ркпрлЗрк▓рлБркВ ркЫрлЗ) -->
        <div id="loading-auth">
            <!-- ркЖ Div рк╣рк╡рлЗ ркЦрк╛рк▓рлА ркЫрлЗ ркЕркирлЗ ркХрлЛркб ркжрлНрк╡рк╛рк░рк╛ ркЫрлБрккрк╛ркпрлЗрк▓рлБркВ ркЫрлЗ -->
        </div>

        <!-- рк╕рлВркЪркирк╛ркУ -->
        <div class="p-3 bg-yellow-100 border-l-4 border-yellow-500 rounded-md">
            <p class="text-sm font-medium text-yellow-800">рк╕рлВркЪркирк╛:</p>
            <p class="text-md text-yellow-700 font-semibold">ркдркорк╛рко рккркВркХрлНркдрк┐ркУ (ркЖркбрлА) ркЕркирлЗ рк╕рлНркдркВркнрлЛ (ркКркнрлА)ркирлЛ рк╕рк░рк╡рк╛рк│рлЛ ркирлАркЪрлЗ ркЖрккрлЗрк▓ 'рк▓ркХрлНрк╖рлНркп рк╕рк░рк╡рк╛рк│рк╛' ркмрк░рк╛ркмрк░ ркерк╛ркп ркдрлЗ рк░рлАркдрлЗ ркЦрк╛рк▓рлА ркмрлЛркХрлНрк╕ ркнрк░рлЛ.</p>
        </div>

        <!-- рк▓ркХрлНрк╖рлНркп рк╕рк░рк╡рк╛рк│рлЛ -->
        <div class="text-center">
            <p class="text-xl font-semibold text-gray-700">рк▓ркХрлНрк╖рлНркп рк╕рк░рк╡рк╛рк│рлЛ (Target Sum):</p>
            <div id="target-sum-display" class="inline-block px-6 py-2 mt-2 text-3xl font-bold text-white bg-blue-600 rounded-full shadow-lg shadow-blue-300/50">--</div>
        </div>

        <!-- ркХрлЛркпркбрлЛ ркЧрлНрк░рлАркб ркЕркирлЗ рк╕рк░рк╡рк╛рк│рк╛ркирк╛ рк╕рлВркЪркХ -->
        <div id="puzzle-layout" class="w-full max-w-sm mx-auto p-2">
            
            <!-- 1. The 3x3 grid + 3 Row Sums (4 columns) -->
            <!-- grid-cols-[] ркирлЛ ркЙрккркпрлЛркЧ 3 ркЧрлНрк░рлАркб ркХрлЛрк╖рлЛ ркЕркирлЗ 1 ркУркЯрлЛ-рк╕рк╛ркЗркЭрлНркб рк╕рк░рк╡рк╛рк│рк╛ ркХрлЙрк▓рко ркорк╛ркЯрлЗ ркерк╛ркп ркЫрлЗ -->
            <div id="grid-and-row-sums" class="grid gap-2" style="grid-template-columns: repeat(3, minmax(0, 1fr)) auto;">
                <!-- Cells (i, j) ркЕркирлЗ Row Sums (i) ркЕрк╣рлАркВ рк░рлЗркирлНркбрк░ ркерк╢рлЗ -->
            </div>

            <!-- 2. The 3 Column Sums + 1 Corner cell (4 columns) -->
            <div id="col-sums-and-corner" class="grid gap-2 mt-2" style="grid-template-columns: repeat(3, minmax(0, 1fr)) auto;">
                <!-- Column Sums (j) ркЕрк╣рлАркВ рк░рлЗркирлНркбрк░ ркерк╢рлЗ -->
                <!-- Corner Cell (ркЦрк╛рк▓рлА ркЦрлВркгрлЛ) -->
            </div>
        </div>

        <!-- ркмркЯркирлЛ -->
        <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4 pt-4">
            <button id="check-btn" class="flex-1 w-full sm:w-auto px-6 py-3 text-lg font-bold text-white bg-green-500 rounded-lg shadow-lg shadow-green-400/50 hover:bg-green-600 transition duration-150 transform hover:scale-105" onclick="checkSolution()">
                тЬЕ ркЬрк╡рк╛ркм ркЪркХрк╛рк╕рлЛ
            </button>
            <button id="new-puzzle-btn" class="flex-1 w-full sm:w-auto px-6 py-3 text-lg font-bold text-white bg-red-500 rounded-lg shadow-lg shadow-red-400/50 hover:bg-red-600 transition duration-150 transform hover:scale-105" onclick="generatePuzzle()">
                ЁЯФД ркирк╡рлЛ ркХрлЛркпркбрлЛ
            </button>
        </div>
        
        <!-- рк╕рлНркЯрлЗркЯрк╕ рклрлАркбркмрлЗркХ -->
        <div id="status-feedback" class="text-center text-lg font-semibold py-2 rounded-lg transition-colors duration-300 h-10">
            <!-- ркЕрк╣рлАркВ ркпрлБркЭрк░ркирлЗ рклрлАркбркмрлЗркХ ркорк│рк╢рлЗ -->
        </div>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase (required boilerplate)
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        
        // Use the global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /**
         * Firebase ркирлЗ рккрлНрк░рк╛рк░ркВркн ркХрк░рлЗ ркЫрлЗ ркЕркирлЗ рк╡рккрк░рк╛рк╢ркХрк░рлНркдрк╛ркирлЗ рккрлНрк░ркорк╛ркгрк┐ркд ркХрк░рлЗ ркЫрлЗ.
         */
        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config is missing. Skipping Firestore initialization.");
                    // document.getElementById('loading-auth').textContent = 'Firebase рккрлНрк░рк╛рк░ркВркн (Initialization) ркЫрлЛркбрлА ркжрлЗрк╡рк╛ркпрлЛ.'; // UI ркорк╛ркВ ркХркВркИрккркг рккрлНрк░ркжрк░рлНрк╢рк┐ркд ркХрк░рк╢рлЛ ркирк╣рлАркВ
                    window.userId = 'anonymous-user'; // fallback
                    window.generatePuzzle(); 
                    return;
                }
                
                window.app = initializeApp(firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);
                setLogLevel('error'); // рклркХрлНркд ркнрлВрк▓рлЛ рк▓рлЛркЧ ркХрк░рлЛ

                // рккрлНрк░ркорк╛ркгрлАркХрк░ркг (Authentication)
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }

                // рккрлНрк░ркорк╛ркгрлАркХрк░ркг рк╕рлНркерк┐ркдрк┐ркорк╛ркВ рклрлЗрк░рклрк╛рк░ ркорк╛ркЯрлЗ рк╕рк╛ркВркнрк│рлЛ
                onAuthStateChanged(window.auth, (user) => {
                    if (user) {
                        window.userId = user.uid;
                        // рк╡рккрк░рк╛рк╢ркХрк░рлНркдрк╛ ID ркЕрк╣рлАркВркерлА ркжрлВрк░ ркХрк░рк╡рк╛ркорк╛ркВ ркЖрк╡рлНркпрлБркВ ркЫрлЗ.
                        window.generatePuzzle(); 
                    } else {
                        window.userId = crypto.randomUUID(); // Fallback for anonymous
                        window.generatePuzzle(); 
                    }
                });

            } catch (error) {
                console.error("Firebase рккрлНрк░рк╛рк░ркВркнркорк╛ркВ ркнрлВрк▓:", error);
                // document.getElementById('loading-auth').textContent = `Firebase ркнрлВрк▓: ${error.message}`; // UI ркорк╛ркВ ркХркВркИрккркг рккрлНрк░ркжрк░рлНрк╢рк┐ркд ркХрк░рк╢рлЛ ркирк╣рлАркВ
                window.userId = crypto.randomUUID(); // Fallback
                window.generatePuzzle(); 
            }
        }

        // DOM рк▓рлЛркб ркеркпрк╛ рккркЫрлА Firebase рк╢рк░рлВ ркХрк░рлЛ
        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>

    <script>
        // ркЧрлНрк▓рлЛркмрк▓ ркЧрлЗрко рк╕рлНркЯрлЗркЯ
        let solutionGrid = [[]]; // рк╕рк╛ркЪрлЛ ркЬрк╡рк╛ркм
        let targetSum = 0;
        const GRID_SIZE = 3;
        const MAX_SINGLE_DIGIT = 9; // ркХрлЛрк╖рлЛркорк╛ркВ ркорк╣ркдрлНркдрко ркорлВрк▓рлНркп

        /**
         * ркПркХ рк░рлЗркирлНркбрко рккрлВрк░рлНркгрк╛ркВркХ ркорлЗрк│рк╡рлЗ ркЫрлЗ.
         * @param {number} min рк▓ркШрлБркдрлНркдрко ркорлВрк▓рлНркп (рк╕ркорк╛рк╡рк┐рк╖рлНркЯ).
         * @param {number} max ркорк╣ркдрлНркдрко ркорлВрк▓рлНркп (рк╕ркорк╛рк╡рк┐рк╖рлНркЯ).
         * @returns {number} рк░рлЗркирлНркбрко рккрлВрк░рлНркгрк╛ркВркХ.
         */
        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /**
         * рк╕рлНркЯрлЗркЯрк╕ рклрлАркбркмрлЗркХ ркПрк░рк┐ркпрк╛ркирлЗ ркЕрккркбрлЗркЯ ркХрк░рлЗ ркЫрлЗ.
         * @param {string} text рк╕ркВркжрлЗрк╢ ркЯрлЗркХрлНрк╕рлНркЯ.
         * @param {string} colorClass Tailwind ркХрк▓рк░ ркХрлНрк▓рк╛рк╕ (ркжрк╛.ркд., 'bg-green-100 text-green-700').
         */
        function updateStatus(text, colorClass) {
            const statusDiv = document.getElementById('status-feedback');
            // рккрк╣рлЗрк▓рк╛ркирк╛ ркХрк▓рк░ ркХрлНрк▓рк╛рк╕ ркжрлВрк░ ркХрк░рлЛ
            statusDiv.className = 'text-center text-lg font-semibold py-2 rounded-lg transition-colors duration-300 h-10'; 
            statusDiv.textContent = text;
            if (colorClass) {
                statusDiv.classList.add(...colorClass.split(' '));
            }
        }

        /**
         * 20 рк╕рлБркзрлАркирк╛ рк▓ркХрлНрк╖рлНркп рк╕рк░рк╡рк╛рк│рк╛ рк╕рк╛ркерлЗ рк░рлЗркирлНркбрко ркХрлЛркпркбрлЛ ркЬркирк░рлЗркЯ ркХрк░рлЗ ркЫрлЗ.
         */
        window.generatePuzzle = function() {
            // 1. рк▓ркХрлНрк╖рлНркп рк╕рк░рк╡рк╛рк│рлЛ 10 ркерлА 20 рк╡ркЪрлНркЪрлЗ рк░рлЗркирлНркбркорк▓рлА ркиркХрлНркХрлА ркХрк░рлЛ
            // ркЦрк╛ркдрк░рлА ркХрк░рлЛ ркХрлЗ TargetSum 3 * 1 = 3 ркерлА ркУркЫрлЛ ркиркерлА ркЕркирлЗ 3 * 9 = 27 ркерлА рк╡ркзрлБ ркиркерлА.
            targetSum = getRandomInt(10, 20); 
            solutionGrid = Array(GRID_SIZE).fill(0).map(() => Array(GRID_SIZE).fill(0));

            const maxCellVal = Math.min(MAX_SINGLE_DIGIT, targetSum - 2); // ркЦрк╛ркдрк░рлА ркХрк░рлЛ ркХрлЗ 3 ркХрлЛрк╖рлЛркорк╛ркВ рк╕рк░рк╡рк╛рк│рлЛ TargetSum ркХрк░ркдрк╛ркВ рк╡ркзрлА рки ркЬрк╛ркп

            // ркХрлЛркпркбрк╛ркирлА рккрлЗркврлА (generation) ркирлЗ рккрлБркирк░рк╛рк╡рк░рлНркдрк┐ркд ркХрк░рлЛ ркЬрлНркпрк╛ркВ рк╕рлБркзрлА ркорк╛ркирлНркп ркЧрлНрк░рлАркб рки ркорк│рлЗ
            let attempts = 0;
            const MAX_ATTEMPTS = 100;

            while (attempts < MAX_ATTEMPTS) {
                attempts++;
                let isValid = true;

                // 2. рккрлНрк░ркерко ркмрлЗ ркХрлЙрк▓рко ркЕркирлЗ рккрлНрк░ркерко ркмрлЗ рккркВркХрлНркдрк┐ркУ рк░рлЗркирлНркбркорк▓рлА ркнрк░рлЛ (1 ркерлА maxCellVal ркирлА ркЖрк╕рккрк╛рк╕)
                for (let i = 0; i < GRID_SIZE; i++) {
                    for (let j = 0; j < GRID_SIZE; j++) {
                        solutionGrid[i][j] = 0; // рк░рлАрк╕рлЗркЯ
                    }
                }

                for (let i = 0; i < GRID_SIZE - 1; i++) {
                    for (let j = 0; j < GRID_SIZE - 1; j++) {
                        // ркжрк░рлЗркХ ркХрлЛрк╖ркорк╛ркВ ркУркЫрк╛ркорк╛ркВ ркУркЫрлБркВ 1 рк╣рлЛрк╡рлБркВ ркЬрлЛркИркП
                        solutionGrid[i][j] = getRandomInt(1, maxCellVal); 
                    }
                }
                
                // 3. ркЫрлЗрк▓рлНрк▓рк╛ рк╕рлНркдркВркн ркЕркирлЗ рккркВркХрлНркдрк┐ркорк╛ркВ ркЦрлВркЯркдрк╛ ркорлВрк▓рлНркпрлЛркирлА ркЧркгркдрк░рлА ркХрк░рлЛ
                
                // ркЫрлЗрк▓рлНрк▓рк╛ рк╕рлНркдркВркнркирлА ркЧркгркдрк░рлА (ркЬркоркгрлА ркмрк╛ркЬрлБ)
                for (let i = 0; i < GRID_SIZE - 1; i++) {
                    let rowSum = solutionGrid[i][0] + solutionGrid[i][1];
                    let requiredVal = targetSum - rowSum;
                    
                    if (requiredVal < 1 || requiredVal > MAX_SINGLE_DIGIT) {
                        isValid = false;
                        break;
                    }
                    solutionGrid[i][GRID_SIZE - 1] = requiredVal;
                }
                if (!isValid) continue; // ркЬрлЛ ркЕркорк╛ркирлНркп рк╣рлЛркп ркдрлЛ ркЖркЧрк▓рк╛ рккрлНрк░ркпрк╛рк╕ рккрк░ ркЬрк╛ркУ
                
                // ркЫрлЗрк▓рлНрк▓рлА рккркВркХрлНркдрк┐ркирлА ркЧркгркдрк░рлА (ркирлАркЪрлЗркирлА ркмрк╛ркЬрлБ)
                for (let j = 0; j < GRID_SIZE - 1; j++) {
                    let colSum = solutionGrid[0][j] + solutionGrid[1][j];
                    let requiredVal = targetSum - colSum;

                    if (requiredVal < 1 || requiredVal > MAX_SINGLE_DIGIT) {
                        isValid = false;
                        break;
                    }
                    solutionGrid[GRID_SIZE - 1][j] = requiredVal;
                }
                if (!isValid) continue; // ркЬрлЛ ркЕркорк╛ркирлНркп рк╣рлЛркп ркдрлЛ ркЖркЧрк▓рк╛ рккрлНрк░ркпрк╛рк╕ рккрк░ ркЬрк╛ркУ
                
                // 4. ркЫрлЗрк▓рлНрк▓рлЛ ркХрлЛрк╖ (solutionGrid[2][2]) ркдрккрк╛рк╕рлЛ (ркмркВркирлЗ рккркВркХрлНркдрк┐ ркЕркирлЗ рк╕рлНркдркВркн ркжрлНрк╡рк╛рк░рк╛)
                
                // ркЫрлЗрк▓рлНрк▓рлА рккркВркХрлНркдрк┐ ркжрлНрк╡рк╛рк░рк╛ ркЧркгркдрк░рлА
                const lastRowSum = solutionGrid[GRID_SIZE - 1][0] + solutionGrid[GRID_SIZE - 1][1];
                const valByRow = targetSum - lastRowSum;

                // ркЫрлЗрк▓рлНрк▓рк╛ рк╕рлНркдркВркн ркжрлНрк╡рк╛рк░рк╛ ркЧркгркдрк░рлА
                const lastColSum = solutionGrid[0][GRID_SIZE - 1] + solutionGrid[1][GRID_SIZE - 1];
                const valByCol = targetSum - lastColSum;

                // ркЦрк╛ркдрк░рлА ркХрк░рлЛ ркХрлЗ ркорлВрк▓рлНркпрлЛ рк╕ркорк╛рки ркЫрлЗ, 1 ркерлА 9 ркирлА рк╡ркЪрлНркЪрлЗ ркЫрлЗ, ркЕркирлЗ 0 ркиркерлА
                if (valByRow === valByCol && valByRow >= 1 && valByRow <= MAX_SINGLE_DIGIT) {
                    solutionGrid[GRID_SIZE - 1][GRID_SIZE - 1] = valByRow;
                    isValid = true;
                    break; // ркорк╛ркирлНркп ркХрлЛркпркбрлЛ ркорк│рлНркпрлЛ!
                } else {
                    isValid = false;
                }
            }

            if (attempts >= MAX_ATTEMPTS) {
                console.error("Error: Could not generate a valid puzzle within max attempts. Retrying.");
                return generatePuzzle(); // ркЬрлЛ рккрлНрк░ркпрк╛рк╕ ркирк┐рк╖рлНрклрк│ ркЬрк╛ркп, ркдрлЛ рккрлБркирк░рк╛рк╡рк░рлНркдрки ркХрк░рлЛ
            }

            // 5. ркЦрк╛рк▓рлА ркХрк░рк╡рк╛ ркорк╛ркЯрлЗ ркХрлЛрк╖рлЛркирлА рккрк╕ркВркжркЧрлА
            const cellsToEmpty = getRandomInt(4, 5); // 4 ркХрлЗ 5 ркХрлЛрк╖рлЛ ркЦрк╛рк▓рлА ркХрк░рлЛ
            const allCells = [];
            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    allCells.push({ i, j });
                }
            }
            
            // рк╢рклрк▓ ркХрк░рлЛ ркЕркирлЗ рккрлНрк░ркерко 'cellsToEmpty' ркЬрлЗркЯрк▓рк╛ ркХрлЛрк╖рлЛ рккрк╕ркВркж ркХрк░рлЛ
            for (let i = allCells.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allCells[i], allCells[j]] = [allCells[j], allCells[i]];
            }
            const emptyCells = allCells.slice(0, cellsToEmpty);

            // 6. DOM ркирлЗ ркЕрккркбрлЗркЯ ркХрк░рлЛ
            renderGrid(emptyCells);
            document.getElementById('target-sum-display').textContent = targetSum;
            updateStatus('ркирк╡рлЛ ркХрлЛркпркбрлЛ ркдрлИркпрк╛рк░ ркЫрлЗ. ркмрлЛркХрлНрк╕ ркнрк░рлЛ!', 'text-gray-600'); 
        };

        /**
         * ркЧрлНрк░рлАркбркирлЗ DOM ркорк╛ркВ рк░рлЗркирлНркбрк░ ркХрк░рлЗ ркЫрлЗ.
         * @param {Array<{i: number, j: number}>} emptyCells ркЦрк╛рк▓рлА рк░рк╛ркЦрк╡рк╛ркирк╛ ркХрлЛрк╖рлЛркирлА ркпрк╛ркжрлА.
         */
        function renderGrid(emptyCells) {
            const gridAndRowSumsContainer = document.getElementById('grid-and-row-sums');
            const colSumsAndCornerContainer = document.getElementById('col-sums-and-corner');
            gridAndRowSumsContainer.innerHTML = '';
            colSumsAndCornerContainer.innerHTML = '';

            // 1. 3x3 ркЧрлНрк░рлАркб ркЕркирлЗ рккркВркХрлНркдрк┐ рк╕рк░рк╡рк╛рк│рк╛ (ркЬркоркгрлА ркмрк╛ркЬрлБ) рк░рлЗркирлНркбрк░ ркХрк░рлЛ
            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    const isInput = emptyCells.some(cell => cell.i === i && cell.j === j);
                    
                    const cellDiv = document.createElement('div');
                    cellDiv.classList.add('grid-cell');
                    
                    if (isInput) {
                        // ркЗркирлНркЯрк░рлЗркХрлНркЯрк┐рк╡ ркЗркирккрлБркЯ ркмрлЛркХрлНрк╕
                        const input = document.createElement('input');
                        input.type = 'number';
                        input.min = '1';
                        input.max = MAX_SINGLE_DIGIT; // ркорк╣ркдрлНркдрко 9 рк╕рлБркзрлА ркЬ ркоркВркЬрлВрк░рлА ркЖрккрлЛ
                        input.maxLength = '1';
                        input.classList.add('input-cell', 'w-full', 'h-full', 'text-2xl', 'p-1');
                        input.setAttribute('data-row', i);
                        input.setAttribute('data-col', j);
                        input.value = '';
                        input.addEventListener('input', (e) => {
                            // ркЗркирккрлБркЯркирлЗ 1 ркЕркВркХ рк╕рлБркзрлА ркорк░рлНркпрк╛ркжрк┐ркд ркХрк░рлЛ ркЕркирлЗ ркЦрк╛ркдрк░рлА ркХрк░рлЛ ркХрлЗ ркдрлЗ 1-9 рк╡ркЪрлНркЪрлЗ ркЫрлЗ
                            e.target.value = e.target.value.replace(/[^1-9]/g, '').slice(0, 1);
                            // ркЗркирккрлБркЯ рккркЫрлА рк╕рлНркЯрлЗркЯрк╕ рк░рлАрк╕рлЗркЯ ркХрк░рлЛ
                            updateStatus('ркЬрк╡рк╛ркм ркЪркХрк╛рк╕рк╡рк╛ ркорк╛ркЯрлЗ тЬЕ ркмркЯрки ркжркмрк╛рк╡рлЛ.', 'text-gray-600');
                        });
                        cellDiv.appendChild(input);
                    } else {
                        // рклрк┐ркХрлНрк╕рлНркб ркиркВркмрк░
                        cellDiv.classList.add('fixed-cell', 'shadow-md');
                        cellDiv.textContent = solutionGrid[i][j];
                    }
                    gridAndRowSumsContainer.appendChild(cellDiv);
                }

                // 4th column: рккркВркХрлНркдрк┐ рк╕рк░рк╡рк╛рк│рк╛ (ркЬркоркгрлА ркмрк╛ркЬрлБ) - placeholder
                const rowSumDiv = document.createElement('div');
                rowSumDiv.id = `row-sum-${i}`;
                rowSumDiv.textContent = `=?`; 
                rowSumDiv.classList.add('sum-display', 'w-auto', 'h-full', 'text-gray-500');
                gridAndRowSumsContainer.appendChild(rowSumDiv);
            }
            
            // 2. рк╕рлНркдркВркн рк╕рк░рк╡рк╛рк│рк╛ (ркирлАркЪрлЗ) ркЕркирлЗ ркЦрлВркгрлЛ рк░рлЗркирлНркбрк░ ркХрк░рлЛ
            for (let j = 0; j < GRID_SIZE; j++) {
                // рк╕рлНркдркВркн рк╕рк░рк╡рк╛рк│рк╛ (ркирлАркЪрлЗ) - placeholder
                const colSumDiv = document.createElement('div');
                colSumDiv.id = `col-sum-${j}`;
                colSumDiv.textContent = `=?`; 
                colSumDiv.classList.add('sum-display', 'col-sum-display', 'w-full', 'text-gray-500');
                colSumsAndCornerContainer.appendChild(colSumDiv);
            }

            // 4th column of the bottom row: ркЦрк╛рк▓рлА ркЦрлВркгрлЛ
            const cornerDiv = document.createElement('div');
            cornerDiv.classList.add('w-auto', 'h-full');
            colSumsAndCornerContainer.appendChild(cornerDiv);
        }

        /**
         * рк╡рккрк░рк╛рк╢ркХрк░рлНркдрк╛ркирк╛ ркЬрк╡рк╛ркмркирлА ркЪркХрк╛рк╕ркгрлА ркХрк░рлЗ ркЫрлЗ.
         */
        window.checkSolution = function() {
            const inputs = document.querySelectorAll('.input-cell');
            let isSolved = true;
            
            // 1. ркЗркирккрлБркЯрлНрк╕ркорк╛ркВркерлА рк╡рк░рлНркдркорк╛рки ркЧрлНрк░рлАркб ркорлЗрк│рк╡рлЛ ркЕркирлЗ ркЦрк╛рк▓рлА ркХрлЛрк╖рлЛ ркдрккрк╛рк╕рлЛ
            const currentGrid = Array(GRID_SIZE).fill(0).map(() => Array(GRID_SIZE).fill(0));
            let allFilled = true;

            inputs.forEach(input => {
                const val = parseInt(input.value);
                
                if (isNaN(val) || val <= 0) {
                    allFilled = false;
                    input.classList.add('border-yellow-500', 'ring-2', 'ring-yellow-300');
                    return;
                }
                input.classList.remove('border-yellow-500', 'ring-2', 'ring-yellow-300');
            });
            
            if (!allFilled) {
                updateStatus("тЭЧ ркХрлГрккрк╛ ркХрк░рлАркирлЗ ркмркзрк╛ ркЦрк╛рк▓рлА ркмрлЛркХрлНрк╕ркорк╛ркВ рк╕ркВркЦрлНркпрк╛ркУ ркнрк░рлЛ.", 'bg-yellow-100 text-yellow-700');
                return;
            }

            // 2. рк╕ркВрккрлВрк░рлНркг ркЧрлНрк░рлАркб ркмркирк╛рк╡рлЛ
            const cells = document.querySelectorAll('#grid-and-row-sums > .grid-cell');
            cells.forEach((cell, index) => {
                // 3x3 ркЧрлНрк░рлАркб ркорк╛ркЯрлЗ ркпрлЛркЧрлНркп ркЗркирлНркбрлЗркХрлНрк╕рк┐ркВркЧ:
                const i = Math.floor(index / GRID_SIZE); 
                const j = index % GRID_SIZE;           
                
                const input = cell.querySelector('input');
                if (input) {
                    currentGrid[i][j] = parseInt(input.value) || 0;
                } else {
                    currentGrid[i][j] = parseInt(cell.textContent) || 0;
                }
            });

            // 3. рккркВркХрлНркдрк┐ркУ ркЕркирлЗ рк╕рлНркдркВркнрлЛркирк╛ рк╕рк░рк╡рк╛рк│рк╛ркирлА ркЪркХрк╛рк╕ркгрлА
            for (let k = 0; k < GRID_SIZE; k++) {
                let rowSum = 0;
                let colSum = 0;
                
                for (let l = 0; l < GRID_SIZE; l++) {
                    rowSum += currentGrid[k][l]; 
                    colSum += currentGrid[l][k]; 
                }

                // рккркВркХрлНркдрк┐ рк╕рк░рк╡рк╛рк│рк╛ркирлА ркЪркХрк╛рк╕ркгрлА (ркЬркоркгрлА ркмрк╛ркЬрлБ)
                const rowSumDiv = document.getElementById(`row-sum-${k}`);
                rowSumDiv.classList.remove('text-green-600', 'text-red-500', 'text-gray-500'); 
                if (rowSum === targetSum) {
                    rowSumDiv.classList.add('text-green-600');
                } else {
                    isSolved = false;
                    rowSumDiv.classList.add('text-red-500');
                }
                rowSumDiv.textContent = `=${rowSum} ${rowSum === targetSum ? 'тЬЕ' : 'тЭМ'}`;

                // рк╕рлНркдркВркн рк╕рк░рк╡рк╛рк│рк╛ркирлА ркЪркХрк╛рк╕ркгрлА (ркирлАркЪрлЗ)
                const colSumDiv = document.getElementById(`col-sum-${k}`);
                colSumDiv.classList.remove('text-green-600', 'text-red-500', 'text-gray-500'); 
                if (colSum === targetSum) {
                    colSumDiv.classList.add('text-green-600');
                } else {
                    isSolved = false;
                    colSumDiv.classList.add('text-red-500');
                }
                colSumDiv.textContent = `=${colSum} ${colSum === targetSum ? 'тЬЕ' : 'тЭМ'}`;
            }

            // 4. ркЕркВркдрк┐рко рк╕ркВркжрлЗрк╢ (рк╣рк╡рлЗ рк╕рлНркЯрлЗркЯрк╕ ркПрк░рк┐ркпрк╛ркорк╛ркВ)
            if (isSolved) {
                updateStatus("ЁЯе│ ркЕркнрк┐ркиркВркжрки! ркХрлЛркпркбрлЛ ркмрк░рк╛ркмрк░ ркЙркХрлЗрк▓рк╛ркИ ркЧркпрлЛ ркЫрлЗ!", 'bg-green-100 text-green-700');
            } else {
                updateStatus("ЁЯдФ ркЬрк░рк╛ рклрк░рлА рккрлНрк░ркпрк╛рк╕ ркХрк░рлЛ. ркнрлВрк▓ркнрк░рлЗрк▓рк╛ рк╕рк░рк╡рк╛рк│рк╛рк╡рк╛рк│рлА рккркВркХрлНркдрк┐ркУ/рк╕рлНркдркВркнрлЛ рк▓рк╛рк▓ рк░ркВркЧркорк╛ркВ рк╣рк╛ркЗрк▓рк╛ркЗркЯ ркХрк░рлЗрк▓ ркЫрлЗ.", 'bg-red-100 text-red-700');
            }
        };

        // рккрлЗркЬ рк▓рлЛркб ркерк╛ркп ркдрлНркпрк╛рк░рлЗ ркСркЯрлЛркорлЗркЯрк┐ркХрк▓рлА рккрлНрк░ркерко ркХрлЛркпркбрлЛ рк╢рк░рлВ ркХрк░рлЛ.
        // ркирлЛркВркз: Firebase рккрлНрк░рк╛рк░ркВркн ркеркпрк╛ рккркЫрлА generatePuzzle() ркирлЗ ркХрлЙрк▓ ркХрк░рк╡рк╛ркорк╛ркВ ркЖрк╡рлЗ ркЫрлЗ.
    </script>
</body>
</html>
