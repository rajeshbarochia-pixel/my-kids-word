<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>સરવાળા વર્કશીટ</title>
    <!-- Tailwind CSS CDN --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the worksheet appearance and print optimization */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            transition: background-color 0.3s;
        }

        /* Styling for the problem box */
        .problem-box {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center the whole problem box in the grid cell */
            justify-content: center;
            padding: 1rem;
            margin: 0.5rem;
            user-select: none;
            cursor: default;
            border-radius: 0.5rem;
            transition: transform 0.1s, box-shadow 0.1s;
            background-color: #ffffff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }

        /* Container to enforce right alignment for the numbers */
        .problem-alignment-container {
            width: 100px; /* Fixed width to ensure vertical stacking alignment */
            line-height: 1;
        }
        
        .number-row {
            font-size: 2.5rem;
            line-height: 1;
            padding-right: 4px; /* Small padding for visual balance */
        }
        
        .operator-row {
            display: flex;
            justify-content: flex-end; /* Align the row content to the right */
            align-items: center;
        }

        .plus-sign {
            font-size: 2.5rem;
            line-height: 1;
            margin-right: 0.5rem; /* Space between plus and number */
        }

        .line {
            width: 90%; /* Increase width for better look */
            height: 3px;
            background-color: #333;
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            /* To center the line which is inside the 100px container */
            align-self: center; 
        }

        .answer-input {
            width: 80px;
            /* Text alignment remains right, but the font will be 'Inter' which supports Devnagari/Gujarati */
            text-align: right; 
            font-size: 1.5rem;
            border: 3px solid #ccc; /* Border increased from 2px to 3px */
            border-radius: 0.375rem;
            padding: 0.25rem 4px;
            background-color: #fff;
            transition: border-color 0.2s; /* Smooth transition for color feedback */
            /* Ensure the font is consistent for proper Gujarati numeral display */
            font-family: 'Inter', sans-serif; 
        }

        /* Hide the native up/down increment/decrement buttons (spinners) from number inputs */
        .answer-input::-webkit-outer-spin-button,
        .answer-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Important: Change type=number to type=text for full control over displaying Gujarati numerals */
        .answer-input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }
        /* End Hide Buttons */

        /* --- Print Styles (A4 Optimization) --- */
        @media print {
            @page {
                size: A4; /* Set paper size to A4 */
                margin: 1cm; /* Set minimal margins */
            }

            body {
                margin: 0;
                padding: 0;
                background-color: #fff;
            }

            .print-hidden {
                display: none !important;
            }

            #worksheet-header {
                display: flex;
                justify-content: space-between; /* Space out the title and creator */
                align-items: flex-end;
                margin-bottom: 20pt;
                font-size: 14pt;
                padding: 0 10pt;
            }
            #worksheet-header .creator-info {
                font-size: 10pt; /* Smaller font for creator info */
                color: #555;
            }


            #worksheet-grid {
                /* Set grid to fill A4 page width */
                width: 100%;
                /* 5 columns changed to 4 columns for A4 print */
                grid-template-columns: repeat(4, 1fr); 
                /* Gap increased to reduce overlapping */
                gap: 40px 10px; 
                padding: 20px 10px;
                display: grid; /* Ensure grid display is set for print */
            }

            .problem-box {
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
                font-size: 14pt;
                /* Increased height for more space in the row */
                height: 180px; 
            }

            .problem-alignment-container {
                width: 100%; /* Use full available width within the cell */
                max-width: 150pt; /* પહોળાઈ વધારી */
                margin-left: auto; /* Center alignment */
                margin-right: auto;
            }
            
            .number-row {
                /* Font size reduced to 30pt for smaller print size */
                font-size: 30pt; 
                line-height: 1.2;
            }

            .plus-sign {
                 /* Font size reduced to 30pt for smaller print size */
                font-size: 30pt; 
            }

            .line {
                width: 90%;
                height: 2pt;
                background-color: #000;
                /* Increased margin to provide more space for writing answer */
                margin-bottom: 50pt; 
            }
            
            /* Answer input element style for printing (always visible in print mode now) */
            .answer-input {
                /* Show the box border for both filled and empty answers */
                display: block; 
                width: 100pt; /* પહોળાઈ વધારી */
                border: 1pt solid #000; /* Solid border for the box */
                border-radius: 0.375rem; 
                padding: 0.25rem 4px;
                margin-top: 5pt;
                background-color: #fff; 
                pointer-events: none; 
                color: #000; 
                /* Font size reduced to 24pt for smaller print size */
                font-size: 24pt; 
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">
    <!-- Main Application Container --><div class="max-w-5xl mx-auto bg-white p-6 rounded-xl shadow-2xl">
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-4 text-green-700">સરવાળા વર્કશીટ</h1>
        <p class="text-center text-gray-600 mb-6 print-hidden">રેન્ડમલી દાખલાઓ જનરેટ કરવા માટે 'નવી વર્કશીટ' બટન દબાવો. જવાબ દાખલ કરતા જ ચકાસણી થશે. બધા જવાબો આપ્યા પછી સ્કોર આપોઆપ આવી જશે.</p>

        <!-- Header for Print (Creator Info) --><div id="worksheet-header" class="text-right text-lg mb-6">
            <!-- Hidden on screen, visible on print --><h2 class="font-bold text-xl text-green-700 print-hidden">સરવાળા વર્કશીટ</h2>
            <!-- Creator Info --><div class="creator-info text-sm text-gray-500">બનાવનાર: Rajesh Barochia</div>
        </div>


        <!-- Control Buttons (Hidden in Print) --><div id="controls" class="flex flex-wrap justify-center gap-3 mb-6 print-hidden">
            <button id="new-worksheet-btn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition duration-200">
                નવી વર્કશીટ જનરેટ કરો
            </button>
            <!-- Print buttons removed as per user request -->
        </div>
        
        <!-- User ID Display (For Firestore Context) --><div id="user-info" class="text-xs text-gray-500 text-center mb-4 print-hidden hidden"></div>

        <!-- Worksheet Grid -->
        <div id="worksheet-grid" class="grid grid-cols-3 sm:grid-cols-4 gap-4 p-4 border-2 border-dashed border-gray-300 rounded-lg">
            <!-- Problems will be inserted here by JavaScript -->
            <div class="problem-box col-span-3 sm:col-span-4 text-center text-xl text-gray-500">
                શરૂ કરવા માટે 'નવી વર્કશીટ જનરેટ કરો' બટન દબાવો.
            </div>
        </div>

        <!-- Message/Modal Area --><div id="message-area" class="mt-6 p-4 text-center text-lg font-semibold rounded-lg hidden"></div>
    </div>

    <!-- Firebase Imports and Script --><script type="module">
        // Mandatory Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Only keep necessary Auth imports, remove Firestore imports
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Firebase Global Variables (Mandatory usage)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let auth;
        let userId = 'default-user'; // Simplify since persistence is removed
        let isAuthReady = true; // No complex checks needed
        let currentProblems = [];
        // WORKSHEET_COUNT ને 20 રાખ્યું છે (4 કૉલમ્સ * 5 હરોળ)
        const WORKSHEET_COUNT = 20; // 4 columns * 5 rows

        /**
         * Converts Arabic numerals (0-9) to Gujarati numerals (૦-૯).
         * @param {number|string} number - The number to convert.
         * @returns {string} The number represented using Gujarati numerals.
         */
        function convertToGujaratiNumerals(number) {
            if (number === null || number === undefined) return '';
            const gujaratiMap = {
                '0': '૦', '1': '૧', '2': '૨', '3': '૩', '4': '૪',
                '5': '૫', '6': '૬', '7': '૭', '8': '૮', '9': '૯'
            };
            return String(number).replace(/[0-9]/g, digit => gujaratiMap[digit]);
        }

        /**
         * Converts Gujarati numerals (૦-૯) back to Arabic numerals (0-9).
         * This is necessary for internal validation and `parseInt()`.
         * @param {string} gujaratiNumber - The number represented using Gujarati numerals.
         * @returns {string} The number represented using Arabic numerals.
         */
        function convertToArabicNumerals(gujaratiNumber) {
            if (gujaratiNumber === null || gujaratiNumber === undefined) return '';
            const arabicMap = {
                '૦': '0', '૧': '1', '૨': '2', '૩': '3', '૪': '4',
                '૫': '5', '૬': '6', '૭': '7', '૮': '8', '૯': '9'
            };
            return String(gujaratiNumber).replace(/[૦-૯]/g, digit => arabicMap[digit]);
        }


        /**
         * Temporary manipulates input values and triggers print.
         * Then restores original values.
         * NOTE: This function is kept for clean removal of print functions,
         * but is no longer connected to any button.
         * @param {string} mode - 'blank' or 'answers'
         */
        function printWorksheet(mode) {
            // 1. Get all visible input elements on the grid
            const inputElements = document.querySelectorAll('.answer-input');
            
            // 2. Store original values to restore later
            const originalValues = Array.from(inputElements).map(input => input.value);
            
            // 3. Temporarily modify input values based on mode
            inputElements.forEach((input, index) => {
                const problemIndex = parseInt(input.dataset.index);
                const problem = currentProblems[problemIndex];

                if (mode === 'answers' && problem) {
                    // Fill with correct answer for 'answers' mode (in Gujarati for display)
                    input.value = convertToGujaratiNumerals(problem.answer); 
                } else if (mode === 'blank') {
                    // Clear for 'blank' mode
                    input.value = '';
                }
            });

            // 4. Trigger print after a short delay
            setTimeout(() => {
                window.print();

                // 5. Restore original values after printing
                inputElements.forEach((input, index) => {
                    input.value = originalValues[index];
                    
                    // Re-apply border style feedback based on restored value
                    const problemIndex = parseInt(input.dataset.index);
                    checkSingleAnswer(problemIndex, input.value); 
                });
                
            }, 50); 
        }

        /**
         * Attaches all event listeners to buttons.
         */
        function setupEventListeners() {
            document.getElementById('new-worksheet-btn').addEventListener('click', generateWorksheet);
            // Print buttons listeners removed
        }


        /**
         * Firebase Initialization and Authentication
         */
        const initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);

                // Directly sign in anonymously or with custom token
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || 'guest-user';
                isAuthReady = true;

                document.getElementById('user-info').classList.add('hidden'); 
                console.log("Firebase initialized. User ID:", userId);

                showMessage("શરૂ કરવા માટે 'નવી વર્કશીટ જનરેટ કરો' બટન દબાવો.", 'bg-orange-100 text-orange-700');
                
                setupEventListeners();

            } catch (error) {
                console.error("Error initializing Firebase/Auth:", error);
                isAuthReady = true;
                userId = crypto.randomUUID();
                document.getElementById('user-info').classList.add('hidden');
                showMessage("શરૂ કરવા માટે 'નવી વર્કશીટ જનરેટ કરો' બટન દબાવો.", 'bg-orange-100 text-orange-700');
                
                setupEventListeners();
            }
        };

        /**
         * Addition Problem Generation Logic
         */
        function generateProblem() {
            const num1 = Math.floor(Math.random() * 9) + 1;
            const num2 = Math.floor(Math.random() * 9) + 1;
            const answer = num1 + num2;
            // Store userInput as Gujarati numerals now, as it will be displayed that way
            return { num1, num2, answer, userInput: '' }; 
        }

        /**
         * Generates and Renders the Worksheet
         */
        function generateWorksheet() {
            currentProblems = Array.from({ length: WORKSHEET_COUNT }, generateProblem);
            renderWorksheet();
            showMessage("નવી વર્કશીટ જનરેટ થઈ ગઈ છે! હવે જવાબો લખો.", 'bg-blue-100 text-blue-700');
        }

        /**
         * Renders the currentProblems array into the DOM
         */
        function renderWorksheet() {
            const grid = document.getElementById('worksheet-grid');
            grid.innerHTML = ''; // Clear previous content

            currentProblems.forEach((problem, index) => {
                // Convert numbers to Gujarati numerals for display
                const gujaratiNum1 = convertToGujaratiNumerals(problem.num1);
                const gujaratiNum2 = convertToGujaratiNumerals(problem.num2);
                
                const box = document.createElement('div');
                box.className = 'problem-box';
                box.dataset.index = index;
                
                // Determine which value to display in the input. 
                // Since `userInput` is now stored in Gujarati, we display it directly.
                const displayedValue = problem.userInput;


                box.innerHTML = `
                    <div class="problem-alignment-container">
                        <!-- Number 1 - right aligned, using Gujarati numerals --><div class="number-row text-right">${gujaratiNum1}</div>
                        <!-- Number 2 with plus sign - right aligned using flex, using Gujarati numerals --><div class="operator-row">
                            <span class="plus-sign">+</span> 
                            <span class="number-row">${gujaratiNum2}</span>
                        </div>
                        <div class="line"></div>
                    </div>
                    <!-- IMPORTANT: Change type="number" to type="text" to allow Gujarati numeral input/display -->
                    <input type="text" 
                           class="answer-input" 
                           placeholder="?" 
                           value="${displayedValue}" 
                           data-index="${index}" 
                           maxlength="2"
                           pattern="[૦-૯]*" 
                           inputmode="numeric">`;
                grid.appendChild(box);
            });

            // Attach event listener to all new input fields
            document.querySelectorAll('.answer-input').forEach(input => {
                input.addEventListener('input', handleInputChange);
            });
        }

        /**
         * Checks a single answer and provides immediate feedback using border color.
         */
        function checkSingleAnswer(index, userInputGujarati) {
            const problem = currentProblems[index];
            
            // 1. Convert the user input back to Arabic numerals for validation
            const userInputArabic = convertToArabicNumerals(userInputGujarati);
            const isCorrect = parseInt(userInputArabic) === problem.answer;
            const inputElement = document.querySelector(`.answer-input[data-index="${index}"]`);

            if (inputElement) {
                if (userInputGujarati.trim() === '') {
                    // Clear feedback if input is empty
                    inputElement.style.borderColor = '#ccc'; // Default color
                } else if (isCorrect) {
                    // Correct feedback: Green border
                    inputElement.style.borderColor = '#10B981'; // Tailwind green-500
                } else {
                    // Incorrect feedback: Red border
                    inputElement.style.borderColor = '#EF4444'; // Tailwind red-500
                }
            }
        }

        /**
         * Checks if all problems have a non-empty user input.
         */
        function isWorksheetComplete() {
            // Check if every problem has a non-empty user input string (which is now in Gujarati)
            return currentProblems.every(problem => problem.userInput && problem.userInput.trim() !== '');
        }

        /**
         * Saves user input, converts to Gujarati for display, and provides auto feedback on change
         */
        function handleInputChange(event) {
            const input = event.target;
            const index = input.dataset.index;
            let value = input.value.trim(); 
            
            // Only allow maximum 2 characters
            value = value.slice(0, 2);
            
            // Normalize input: If user types Arabic, convert to Gujarati for display
            let gujaratiValue = convertToGujaratiNumerals(value);

            // Update the input field display with Gujarati numerals
            input.value = gujaratiValue;

            // Store the value in Gujarati format for later rendering/printing
            currentProblems[index].userInput = gujaratiValue;
            
            checkSingleAnswer(index, gujaratiValue);

            document.getElementById('message-area').classList.add('hidden');
            
            if (isWorksheetComplete()) {
                checkAnswers();
            }
        }

        /**
         * Checks all answers and provides overall score feedback
         */
        function checkAnswers() {
            let correctCount = 0;
            let totalProblems = currentProblems.length;

            currentProblems.forEach((problem) => {
                // 1. Convert user input (Gujarati numeral string) back to Arabic for validation
                const userInputArabic = convertToArabicNumerals(problem.userInput);
                const userInput = parseInt(userInputArabic);
                
                const isCorrect = userInput === problem.answer;
                if (isCorrect) {
                    correctCount++;
                }
            });

            const score = Math.round((correctCount / totalProblems) * 100);

            // Convert score and counts to Gujarati for display
            const gujaratiCorrectCount = convertToGujaratiNumerals(correctCount);
            const gujaratiTotalProblems = convertToGujaratiNumerals(totalProblems);
            const gujaratiScore = convertToGujaratiNumerals(score);


            if (totalProblems === 0) {
                 showMessage(`કૃપા કરીને પહેલા નવી વર્કશીટ જનરેટ કરો.`, 'bg-red-100 text-red-700');
                 return;
            } else if (correctCount === totalProblems) {
                showMessage(`અભિનંદન! તમામ ${gujaratiTotalProblems} દાખલાઓ સાચા છે!`, 'bg-yellow-100 text-yellow-700');
            } else {
                showMessage(`અંતિમ પરિણામ: ${gujaratiTotalProblems} માંથી ${gujaratiCorrectCount} સાચા (${gujaratiScore}%)`, 'bg-red-100 text-red-700');
            }
        }

        /**
         * Display status messages
         */
        function showMessage(text, className) {
            const messageArea = document.getElementById('message-area');
            messageArea.textContent = text;
            messageArea.className = `mt-6 p-4 text-center text-lg font-semibold rounded-lg ${className}`;
            messageArea.classList.remove('hidden');
        }
        
        // --- Initial Load ---
        window.onload = initializeFirebase;
    </script>
</body>
</html>
