<!doctype html>
<html lang="gu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>બાળકો માટે સ્પિન વ્હીલ (Horizontal Text)</title>

<!-- Gujarati font from Google Fonts for clearer Gujarati rendering -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Gujarati:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6f9fc; --card:#fff; --accent:#2b6cb0; --muted:#666;
  }
  *{box-sizing:border-box}
  body{font-family:"Noto Sans Gujarati", "Noto Sans", system-ui, Arial; margin:0; background:var(--bg); color:#111; padding:18px;}
  .wrap{max-width:1150px;margin:0 auto;display:grid;grid-template-columns:1fr 380px;gap:18px;align-items:start}
  header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
  header h1{font-size:18px;margin:0}
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(20,20,40,.06)}
  #wheelCanvas{width:100%;height:auto;border-radius:8px;display:block;background:linear-gradient(180deg,#fff,#f3f6fb)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;color:var(--accent);border:1px solid #d0d8e6}
  .small{font-size:13px;padding:6px 8px}
  .right-col{position:sticky;top:18px}
  label{display:block;font-size:13px;color:var(--muted);margin-top:10px}
  input[type="text"], textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #e2e8f0;background:#fbfcff}
  .items{max-height:360px;overflow:auto;margin-top:8px}
  .item{display:flex;gap:8px;align-items:center;padding:6px;border-radius:8px;border:1px dashed transparent}
  .item:hover{background:#fbfdff}
  .color-swatch{width:28px;height:28px;border-radius:6px;border:1px solid #dfe7f5}
  .item-text{flex:1;min-width:0}
  .footer{grid-column:1/-1;text-align:left;color:var(--muted);font-size:13px;margin-top:12px}
  .result{margin-top:10px;padding:8px;border-radius:8px;background:#f0fff4;color:#064e3b;border:1px solid #dcfce7}
  @media (max-width:920px){
    .wrap{grid-template-columns:1fr; padding-bottom:40px}
    .right-col{position:static}
  }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>બાળકો માટે સ્પિન વ્હીલ — હોરિઝોન્ટલ ટેક્સ્ટ</h1>
      <div style="font-size:13px;color:var(--muted)">સંસ્કરણ: Horizontal • ઝડપી અને સરળ</div>
    </header>

    <!-- LEFT: Wheel -->
    <div class="card">
      <canvas id="wheelCanvas" width="900" height="900" role="img" aria-label="સ્પિન વ્હીલ"></canvas>

      <div class="controls">
        <button id="spinBtn" class="small">SPIN</button>
        <button id="quickSpin" class="small ghost">Quick</button>
        <button id="stopBtn" class="small ghost">STOP</button>
        <button id="saveBtn" class="small">Save</button>
        <button id="loadBtn" class="small ghost">Load</button>
        <button id="resetBtn" class="small ghost">Reset</button>
      </div>

      <div id="resultBox" class="result" style="display:none" aria-live="polite"></div>
    </div>

    <!-- RIGHT: Editor -->
    <aside class="card right-col">
      <label>નામો / વસ્તુઓ (પ્રતિ લીને એક અથવા શોર્ટ coma-separated)</label>
      <textarea id="itemsInput" rows="5" placeholder="જેમ: અમદાવાદ, રાજકોટ, વડોદરા, પોરબંદર, જામનગર, સુરત"></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="loadFromText" class="small">Apply List</button>
        <button id="importWheelOfNames" class="small ghost" title="Comma separated">Import from wheelofnames-style list</button>
      </div>

      <label>Auto-generate colors?</label>
      <div style="display:flex;gap:8px;margin-top:6px">
        <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="autoColor" checked> Yes</label>
      </div>

      <label style="margin-top:12px">Items (આગે નચે ફેરફાર કરો)</label>
      <div class="items" id="itemsList" aria-live="polite"></div>

      <label style="margin-top:8px">Share / Export</label>
      <div style="display:flex;gap:8px">
        <button id="exportJson" class="small">Export JSON</button>
        <button id="importJson" class="small ghost">Import JSON</button>
        <button id="shareLink" class="small ghost">Copy Share Link</button>
      </div>

      <label style="margin-top:10px">Options</label>
      <div style="display:flex;gap:8px;margin-top:6px">
        <label style="font-size:13px;color:var(--muted)">
          <input type="checkbox" id="soundOn" checked> Sound
        </label>
        <label style="font-size:13px;color:var(--muted)">
          <input type="checkbox" id="confettiOn" checked> Confetti
        </label>
      </div>

      <small style="display:block;margin-top:10px;color:var(--muted)">
        ટિપ: wheelofnames.com માંથી comma-separated list copy કરીને અહીં Paste કરો અને "Apply List" દબાવો.
      </small>
    </aside>

    <div class="footer card" style="text-align:left;">
      <strong>શુરૂઆત કરવા માટે:</strong> સૂચિઓ દાખલ કરો → Apply List → SPIN. (આ ફાઈલમાં ટેક્સ્ટ હંમેશા આડી દેખાશે)
    </div>
  </div>

<script>
/* ---------- Data model ---------- */
const defaultItems = ["અમદાવાદ","રાજકોટ","વડોદરા","પોરબંદર","જામનગર","સુરત","જૂનાગઢ","વલસાડ"];
let items = [];
let colors = [];
const STORAGE_KEY = "kids_spin_wheel_horiz_v1";

/* ---------- Utils ---------- */
function randInt(n){return Math.floor(Math.random()*n)}
function genColor(i,n){
  const hue = Math.round((i*360/n) % 360);
  return `hsl(${hue} 70% 70%)`;
}

/* ---------- Canvas wheel ---------- */
const canvas = document.getElementById('wheelCanvas');
const ctx = canvas.getContext('2d');
let cw = canvas.width, ch = canvas.height;
let cx = cw/2, cy = ch/2, radius = Math.min(cw,ch)*0.42;
let isSpinning = false, angularVelocity = 0, angle = 0;
let animationId = null;

/* draw wheel 
   નોંધ: નીચેનો કોડ દરેક સેગમેન્ટ પર ટેક્સ્ટમાં રોટેશનને રદ્દ કરી દે છે જેથી ટેક્સ્ટ હૉરિઝોન્ટલ દેખાય.
*/
function drawWheel(){
  ctx.clearRect(0,0,cw,ch);
  const n = items.length || 1;
  const seg = 2*Math.PI / n;

  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(angle);

  for(let i=0;i<n;i++){
    const start = i*seg;
    // draw segment
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,radius,start,start+seg);
    ctx.closePath();
    ctx.fillStyle = colors[i] || genColor(i,n);
    ctx.fill();

    // draw border lightly
    ctx.strokeStyle = "rgba(255,255,255,0.12)";
    ctx.stroke();

    // --- Text placement (horizontal) ---
    // 1) rotate to segment center and translate outward to the label point
    ctx.save();
    ctx.rotate(start + seg/2);
    ctx.translate(radius * 0.62, 0);

    // 2) cancel the total rotation (global angle + local segment rotation)
    // so that text drawn now is horizontal relative to the page
    ctx.rotate(-(angle + start + seg/2));

    // 3) dynamic font sizing to fit inside the segment chord
    // chord length at that radius: 2 * R_label * sin(seg/2)
    const Rlabel = radius * 0.62;
    const chord = 2 * Rlabel * Math.sin(seg/2);
    let fontSize = Math.max(12, Math.floor(radius / 9));
    ctx.font = `${fontSize}px "Noto Sans Gujarati", sans-serif`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    let text = items[i] || "—";

    // reduce font size until it fits within 90% of chord width
    const maxWidth = Math.max(24, chord * 0.9);
    let metrics = ctx.measureText(text);
    while(metrics.width > maxWidth && fontSize > 8){
      fontSize -= 1;
      ctx.font = `${fontSize}px "Noto Sans Gujarati", sans-serif`;
      metrics = ctx.measureText(text);
    }

    // finally draw text
    ctx.fillStyle = "#08203a";
    ctx.fillText(text, 0, 0);
    ctx.restore();
  }

  ctx.restore();

  // pointer on the right
  ctx.beginPath();
  ctx.fillStyle = "#ff3b30";
  ctx.moveTo(cx + radius + 10, cy);
  ctx.lineTo(cx + radius + 46, cy - 20);
  ctx.lineTo(cx + radius + 46, cy + 20);
  ctx.closePath();
  ctx.fill();
}

/* animation loop */
function animate(){
  if(!isSpinning){
    cancelAnimationFrame(animationId);
    animationId = null;
    return;
  }
  angle += angularVelocity;
  angularVelocity *= 0.995; // friction
  if(Math.abs(angularVelocity) < 0.0006){
    isSpinning = false;
    finishSpin();
  } else {
    animationId = requestAnimationFrame(animate);
  }
  drawWheel();
}

/* start spin */
function startSpin(forceFast){
  if(isSpinning) return;
  if(items.length === 0) return;
  isSpinning = true;
  angularVelocity = (Math.PI/30) * (forceFast ? (6 + Math.random()*6) : (3 + Math.random()*4));
  if(Math.random() < 0.5) angularVelocity = -angularVelocity;
  animate();
  playSoundTicking();
}

/* stop immediately (brake) */
function stopSpin(){
  angularVelocity = 0.0001;
}

/* determine the result when stop */
function finishSpin(){
  const n = items.length;
  const seg = 2*Math.PI / n;
  let raw = (-angle) / seg;
  let idx = Math.floor(raw) % n;
  if(idx < 0) idx += n;
  const winner = items[idx] || "—";
  showResult(winner);
}

/* result display */
const resultBox = document.getElementById('resultBox');
function showResult(text){
  resultBox.style.display = "block";
  resultBox.textContent = `🎉 Result: ${text}`;
  if(document.getElementById('confettiOn').checked){
    try{ window.confetti && window.confetti({particleCount:80, spread:70}); }catch(e){}
  }
  if(document.getElementById('soundOn').checked){
    playSoundWin();
  }
}

/* ---------- UI helpers ---------- */
function syncFromTextarea(){
  const raw = document.getElementById('itemsInput').value.trim();
  const arr = raw ? raw.split(/\r?\n|,/) .map(s=>s.trim()).filter(Boolean) : [];
  if(arr.length) items = arr.slice(0, 80); // limit
  ensureColors();
  renderItemsEditor();
  drawWheel();
}

function ensureColors(){
  colors = colors || [];
  for(let i=0;i<items.length;i++){
    if(!colors[i]) colors[i] = genColor(i, items.length);
  }
  colors.length = items.length;
}

function renderItemsEditor(){
  const list = document.getElementById('itemsList');
  list.innerHTML = '';
  items.forEach((it,i)=>{
    const row = document.createElement('div');
    row.className = 'item';
    const sw = document.createElement('input');
    sw.type = 'color';
    sw.value = toHex(colors[i] || genColor(i,items.length));
    sw.className = 'color-swatch';
    sw.title = 'Change color';
    sw.addEventListener('input', e=>{
      colors[i] = e.target.value;
      drawWheel();
    });

    const txt = document.createElement('input');
    txt.type = 'text';
    txt.value = it;
    txt.className = 'item-text';
    txt.addEventListener('change', e=>{
      items[i] = e.target.value || `Item ${i+1}`;
      document.getElementById('itemsInput').value = items.join(", ");
      drawWheel();
    });

    const del = document.createElement('button');
    del.className = 'small ghost';
    del.textContent = 'Remove';
    del.addEventListener('click', ()=>{
      items.splice(i,1);
      colors.splice(i,1);
      document.getElementById('itemsInput').value = items.join(", ");
      renderItemsEditor();
      drawWheel();
    });

    row.appendChild(sw);
    row.appendChild(txt);
    row.appendChild(del);
    list.appendChild(row);
  });
}

/* convert HSL (string) to hex or pass-through if already hex */
function toHex(val){
  if(/^#/.test(val)) return val;
  const m = /hsl\((\d+)\s+(\d+)%\s+(\d+)%\)/.exec(val);
  if(!m) return "#cccccc";
  const h = +m[1]/360, s = +m[2]/100, l = +m[3]/100;
  let r,g,b;
  if(s===0) r=g=b=l;
  else {
    const q = l < .5 ? l*(1+s) : l+s - l*s;
    const p = 2*l - q;
    const hue2rgb = (p,q,t) => {
      if(t<0) t+=1; if(t>1) t-=1;
      if(t<1/6) return p + (q-p)*6*t;
      if(t<1/2) return q;
      if(t<2/3) return p + (q-p)*(2/3 - t)*6;
      return p;
    };
    r = hue2rgb(p,q,h + 1/3);
    g = hue2rgb(p,q,h);
    b = hue2rgb(p,q,h - 1/3);
  }
  const toHex2 = v => ("0"+Math.round(v*255).toString(16)).slice(-2);
  return `#${toHex2(r)}${toHex2(g)}${toHex2(b)}`;
}

/* ---------- Persistence / share / import ---------- */
function saveToLocal(){
  const payload = {items,colors,ts:Date.now()};
  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  alert('Saved locally');
}
function loadFromLocal(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ alert('Nothing saved locally'); return; }
  try{
    const data = JSON.parse(raw);
    items = data.items || [];
    colors = data.colors || [];
    document.getElementById('itemsInput').value = items.join(", ");
    renderItemsEditor();
    drawWheel();
  }catch(e){ alert('Load failed'); }
}
function exportJson(){
  const data = {items, colors};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'wheel.json'; a.click();
  URL.revokeObjectURL(url);
}
function importJson(){
  const inp = document.createElement('input');
  inp.type = 'file'; inp.accept = 'application/json';
  inp.onchange = e=>{
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = ev=>{
      try{
        const obj = JSON.parse(ev.target.result);
        items = obj.items || [];
        colors = obj.colors || [];
        document.getElementById('itemsInput').value = items.join(", ");
        renderItemsEditor();
        drawWheel();
      }catch(err){ alert('Invalid JSON'); }
    };
    r.readAsText(f);
  };
  inp.click();
}
function copyShareLink(){
  const data = {items,colors};
  const encoded = encodeURIComponent(btoa(JSON.stringify(data)));
  const link = location.origin + location.pathname + '#wheel=' + encoded;
  navigator.clipboard.writeText(link).then(()=> alert('Link copied to clipboard'));
}
function loadFromShareIfAny(){
  if(location.hash && location.hash.includes('wheel=')){
    try{
      const enc = location.hash.split('wheel=')[1];
      const json = atob(decodeURIComponent(enc));
      const obj = JSON.parse(json);
      items = obj.items || [];
      colors = obj.colors || [];
      document.getElementById('itemsInput').value = items.join(", ");
      renderItemsEditor();
      drawWheel();
    }catch(e){}
  }
}

/* ---------- Sound (simple) ---------- */
function playSoundTicking(){
  if(!document.getElementById('soundOn').checked) return;
  try{
    const ac = new (window.AudioContext || window.webkitAudioContext)();
    const o = ac.createOscillator();
    const g = ac.createGain();
    o.type = "sine";
    o.frequency.value = 800;
    g.gain.value = 0.05;
    o.connect(g); g.connect(ac.destination);
    o.start();
    setTimeout(()=>{ o.stop(); ac.close(); }, 220);
  }catch(e){}
}
function playSoundWin(){
  try{
    const ac = new (window.AudioContext || window.webkitAudioContext)();
    const now = ac.currentTime;
    const g = ac.createGain(); g.gain.value = 0.08;
    const o1 = ac.createOscillator(); o1.type="sine"; o1.frequency.value = 450;
    const o2 = ac.createOscillator(); o2.type="sine"; o2.frequency.value = 660;
    o1.connect(g); o2.connect(g); g.connect(ac.destination);
    o1.start(now); o2.start(now);
    o1.stop(now+0.3); o2.stop(now+0.3);
    setTimeout(()=>ac.close(),400);
  }catch(e){}
}

/* ---------- Events ---------- */
document.getElementById('spinBtn').addEventListener('click', ()=>startSpin(false));
document.getElementById('quickSpin').addEventListener('click', ()=>startSpin(true));
document.getElementById('stopBtn').addEventListener('click', stopSpin);
document.getElementById('saveBtn').addEventListener('click', saveToLocal);
document.getElementById('loadBtn').addEventListener('click', loadFromLocal);
document.getElementById('resetBtn').addEventListener('click', ()=>{
  if(confirm('Reset to default items?')){ items = defaultItems.slice(); colors = []; ensureColors(); document.getElementById('itemsInput').value = items.join(", "); renderItemsEditor(); drawWheel(); }
});

document.getElementById('loadFromText').addEventListener('click', ()=>{
  syncFromTextarea();
});
document.getElementById('importWheelOfNames').addEventListener('click', ()=>{
  syncFromTextarea();
  alert('Applied — you can edit items on the right.');
});
document.getElementById('exportJson').addEventListener('click', exportJson);
document.getElementById('importJson').addEventListener('click', importJson);
document.getElementById('shareLink').addEventListener('click', copyShareLink);

/* keyboard accessibility */
document.addEventListener('keydown', e=>{
  if(e.key === ' ' || e.key === 'Enter'){
    const active = document.activeElement;
    if(active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA')) return;
    e.preventDefault();
    startSpin(false);
  }
});

/* handle window resize to keep canvas crisp */
function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  const ratio = window.devicePixelRatio || 1;
  canvas.width = Math.floor(rect.width * ratio);
  canvas.height = Math.floor(rect.width * ratio); // square canvas
  cw = canvas.width; ch = canvas.height; cx = cw/2; cy = ch/2; radius = Math.min(cw,ch)*0.42;
  drawWheel();
}
window.addEventListener('resize', resizeCanvas);

/* load confetti lib (CDN) for fun */
(function loadConfetti(){
  const s = document.createElement('script');
  s.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js';
  s.onload = ()=> console.log('confetti loaded');
  document.head.appendChild(s);
})();

/* startup */
function init(){
  items = defaultItems.slice();
  colors = [];
  ensureColors();
  document.getElementById('itemsInput').value = items.join(", ");
  renderItemsEditor();
  resizeCanvas();
  loadFromShareIfAny();
}
init();

</script>
</body>
</html>
